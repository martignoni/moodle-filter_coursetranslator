{"version":3,"file":"multilingual.min.js","sources":["../src/multilingual.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @module     filter_multilingual/multilingual\n * @copyright  2022 Kaleb Heitzman <kaleb@jamfire.io>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// import libs\nimport ajax from \"core/ajax\";\nimport * as str from \"core/str\";\n\n/**\n * Translation Editor UI\n * @param {Object} config JS Config\n */\nexport const init = (config) => {\n  // Autosave Translation String\n  let autsavedMsg = \"\";\n  str.get_string(\"t_autosaved\", \"filter_multilingual\").done((string) => {\n    autsavedMsg = string;\n  });\n\n  /**\n   * Convert a template string into HTML DOM nodes\n   * @param  {String} string The template string\n   * @return {Node}       The template HTML\n   */\n  const stringToHTML = (string) => {\n    // See if DOMParser is supported\n    var support = (() => {\n      if (!window.DOMParser) {\n        return false;\n      }\n      var parser = new DOMParser();\n      try {\n        parser.parseFromString(\"x\", \"text/html\");\n      } catch (err) {\n        return false;\n      }\n      return true;\n    })();\n\n    // If DOMParser is supported, use it\n    if (support) {\n      var parser = new DOMParser();\n      var doc = parser.parseFromString(string, \"text/html\");\n      return doc.body.childNodes;\n    }\n\n    // Otherwise, fallback to old-school method\n    var dom = document.createElement(\"div\");\n    dom.innerHTML = string;\n    return dom;\n  };\n\n  /**\n   * Toggle Autotranslate Button\n   */\n  const toggleAutotranslateButton = () => {\n    let checkboxItems = [];\n    checkboxes.forEach(e => {\n      checkboxItems.push(e.checked);\n    });\n    let checked = checkboxItems.find(checked => checked === true) ? true : false;\n    window.console.log(checked);\n    if (config.autotranslate && checked) {\n      autotranslateButton.disabled = false;\n    } else {\n      autotranslateButton.disabled = true;\n    }\n  };\n\n  /**\n   * Select All Checkbox\n   */\n  const selectAll = document.querySelector(\".filter-multilingual_select-all\");\n  if (config.autotranslate) {\n    selectAll.disabled = false;\n  }\n  selectAll.addEventListener(\"click\", (e) => {\n      // See if select all is checked\n      let checked = e.target.checked;\n      let checkboxes = document.querySelectorAll(\".filter-multilingual_select\");\n\n      // Check/uncheck checkboxes\n      if (checked) {\n        checkboxes.forEach((e) => {\n          e.checked = true;\n        });\n      } else {\n        checkboxes.forEach((e) => {\n          e.checked = false;\n        });\n      }\n      toggleAutotranslateButton();\n    });\n\n  /**\n   * Autotranslate Checkboxes\n   */\n  const checkboxes = document.querySelectorAll(\".filter-multilingual_select\");\n  if (config.autotranslate) {\n    checkboxes.forEach(e => {\n      e.disabled = false;\n    });\n  }\n  checkboxes.forEach(e => {\n    e.addEventListener('change', () => {\n      toggleAutotranslateButton();\n    });\n  });\n\n  /**\n   * Autotranslate Button Display\n   * @returns void\n   */\n  const autotranslateButton = document.querySelector(\n    \".multilingual-autotranslate\"\n  );\n\n  /**\n   * Send for Translation to DeepL\n   * @param {Integer} id Translation ID\n   */\n  const getTranslation = (id) => {\n\n    // Get the editor\n    let editor = document.querySelector('.multilingual-editor[data-id=\"' + id + '\"]');\n\n    // Get the source text\n    let sourceText = document.querySelector(\n      '.filter-multilingual__source-text[data-id=\"' + id + '\"]'\n    ).innerHTML;\n\n    // Build formData\n    let formData = new FormData();\n    formData.append(\"text\", sourceText);\n    formData.append(\"source_lang\", \"en\");\n    formData.append(\"target_lang\", config.lang);\n    formData.append(\"preserve_formatting\", 1);\n    formData.append(\"auth_key\", config.apikey);\n    formData.append(\"tag_handling\", \"xml\");\n    formData.append(\"split_sentences\", \"nonewlines\");\n\n    // DeepL URL\n    let url = \"https://api.deepl.com/v2/translate\";\n\n    // Update the translation\n    let xhr = new XMLHttpRequest();\n    xhr.onreadystatechange = () => {\n      if (xhr.readyState === XMLHttpRequest.DONE) {\n        var status = xhr.status;\n        if (status === 0 || (status >= 200 && status < 400)) {\n          // The request has been completed successfully\n          let data = JSON.parse(xhr.responseText);\n          window.console.log(\"deepl:\", id, data);\n          // Display translation\n          editor.innerHTML = data.translations[0].text;\n          // Save translation\n          saveTranslation(id, data.translations[0].text, editor);\n        } else {\n          // Oh no! There has been an error with the request!\n          window.console.log(\"error\", status);\n        }\n      }\n    };\n    xhr.open(\"POST\", url);\n    xhr.send(formData);\n  };\n\n  /**\n   * Autotranslate Button Click\n   * @returns void\n   */\n  autotranslateButton.addEventListener(\"click\", () => {\n    document.querySelectorAll(\".filter-multilingual_select:checked\").forEach(e => {\n      let id = e.getAttribute('data-id');\n      getTranslation(id);\n    });\n  });\n\n  /**\n   * Save Translation to Moodle\n   * @param  {Integer} id Translation ID\n   * @param  {String} translation Translation Text\n   * @param  {Node} editor HTML Editor Node\n   */\n  const saveTranslation = (id, translation, editor) => {\n    // Success Message\n    const successMessage = () => {\n      editor.classList.add(\"filter-multilingual__success\");\n      // Add saved indicator\n      let indicator =\n        '<div class=\"filter-multilingual__success-message\" data-id=\"' +\n        id +\n        '\">' +\n        autsavedMsg +\n        \"</div>\";\n      editor.after(...stringToHTML(indicator));\n      // Remove success message after a few seconds\n      setTimeout(() => {\n        let indicatorNode = document.querySelector(\n          '.filter-multilingual__success-message[data-id=\"' + id + '\"]'\n        );\n        editor.parentNode.removeChild(indicatorNode);\n      }, 3000);\n    };\n\n    // Error Mesage\n    const errorMessage = () => {\n      editor.classList.add(\"filter-multilingual__error\");\n    };\n\n    // Submit the request\n    ajax.call([\n      {\n        methodname: \"filter_multilingual_update_translation\",\n        args: {\n          translation: [\n            {\n              id: id,\n              course_id: config.course_id, // eslint-disable-line\n              translation: translation,\n            },\n          ],\n        },\n        done: (data) => {\n          window.console.log(\"ws: \", id, data);\n          if (data.length > 0) {\n            successMessage();\n          } else {\n            errorMessage();\n          }\n        },\n        fail: (error) => {\n          window.console.log(\"error: \", error);\n          errorMessage();\n          editor.classList.addClass(\"filter-multilingual__error\");\n          window.console.log(error);\n        },\n      },\n    ]);\n  };\n\n  /**\n   * Get the Translation using Moodle Web Service\n   * @returns void\n   */\n  document.querySelectorAll(\".multilingual-editor\").forEach((editor) => {\n    // Save translation\n    editor.addEventListener(\"focusout\", () => {\n      let id = editor.getAttribute(\"data-id\");\n      let translation = editor.innerHTML;\n\n      saveTranslation(id, translation, editor);\n    });\n\n    // Remove status classes\n    editor.addEventListener(\"click\", () => {\n      editor.classList.remove(\"filter-multilingual__success\");\n      editor.classList.remove(\"filter-multilingual__error\");\n    });\n  });\n\n  /**\n   * Add Editor to .multilingual editor\n   */\n  document\n    .querySelectorAll(\".multilingual-editor.format-html\")\n    .forEach((editor) => {\n      let id = editor.getAttribute(\"data-id\");\n\n      let controls =\n        '<div class=\"filter-multilingual__editor-tools\" data-id=\"' +\n        id +\n        '\">' +\n        '<div class=\"btn-toolbar\" role=\"toolbar\" aria-label=\"Editor Toolbar\">' +\n        '<div class=\"btn-group mr-2\" role=\"group\" aria-label=\"Formatting\">' +\n        '<button data-method=\"h2\" type=\"button\" class=\"t-editor-button btn btn-light\"><i class=\"bi-type-h2\"></i></button>' +\n        '<button data-method=\"h3\" type=\"button\" class=\"t-editor-button btn btn-light\"><i class=\"bi-type-h3\"></i></button>' +\n        '<button data-method=\"p\" type=\"button\" class=\"t-editor-button btn btn-light\"><i class=\"bi-paragraph\"></i></button>' +\n        \"</div>\" +\n        '<div class=\"btn-group mr-2\" role=\"group\" aria-label=\"Lists\">' +\n        '<button data-method=\"ol\" type=\"button\" class=\"t-editor-button btn btn-light\"><i class=\"bi-list-ol\"></i></button>' +\n        '<button data-method=\"ul\" type=\"button\" class=\"t-editor-button btn btn-light\"><i class=\"bi-list-ul\"></i></button>' +\n        \"</div>\" +\n        '<div class=\"btn-group mr-2\" role=\"group\" aria-label=\"Styles\">' +\n        '<button data-method=\"b\" type=\"button\" class=\"t-editor-button btn btn-light\"><i class=\"bi-type-bold\"></i></button>' +\n        '<button data-method=\"i\" type=\"button\" class=\"t-editor-button btn btn-light\"><i class=\"bi-type-italic\"></i></button>' +\n        '<button data-method=\"u\" type=\"button\" class=\"t-editor-button btn btn-light\"><i class=\"bi-type-underline\"></i></button>' +\n        \"</div>\" +\n        '<div class=\"btn-group mr-2\" role=\"group\" aria-label=\"Links\">' +\n        '<button data-method=\"l\" type=\"button\" class=\"t-editor-button btn btn-light\"><i class=\"bi-link-45deg\"></i></button>' +\n        \"</div>\" +\n        // '<div class=\"btn-group mr-2\" role=\"group\" aria-label=\"Links\">' +\n        // '<button data-method=\"html\" type=\"button\" class=\"t-editor-button btn btn-light\"><i class=\"bi-code-slash\"></i></button>' +\n        // \"</div>\" +\n        \"</div>\" +\n        \"</div>\";\n\n      editor.parentNode.prepend(...stringToHTML(controls));\n    });\n\n  /**\n   * Switch Translation Language\n   */\n  let localeSwitcher = document.querySelector(\".multilingual-locale-switcher\");\n  localeSwitcher.addEventListener(\"change\", (e) => {\n    let url = new URL(window.location.href);\n    let searchParams = url.searchParams;\n    searchParams.set(\"course_lang\", e.target.value);\n    let newUrl = url.toString();\n\n    window.location = newUrl;\n  });\n\n  /**\n   * Detect Editor Button Click\n   */\n  document.querySelectorAll(\".t-editor-button\").forEach((button) => {\n    button.addEventListener(\"click\", () => {\n      // @todo let id = button.closest('.filter-multilingual__editor-tools').getAttribute('data-id');\n      let method = button.getAttribute(\"data-method\");\n      // @todo let editor = document.querySelector('.multilingual-editor[data-id=\"' + id + '\"]');\n      // @todo let html = editor.innerHTML;\n\n      switch (method) {\n        case \"h2\":\n          document.execCommand(\"formatBlock\", false, \"<h2>\");\n          break;\n        case \"h3\":\n          document.execCommand(\"formatBlock\", false, \"<h3>\");\n          break;\n        case \"p\":\n          document.execCommand(\"formatBlock\", false, \"<p>\");\n          break;\n        case \"ol\":\n          document.execCommand(\"insertOrderedList\");\n          break;\n        case \"ul\":\n          document.execCommand(\"insertUnorderedList\");\n          break;\n        case \"b\":\n          document.execCommand(\"bold\");\n          break;\n        case \"i\":\n          document.execCommand(\"italic\");\n          break;\n        case \"u\":\n          document.execCommand(\"underline\");\n          break;\n        case \"l\":\n          var link = prompt(\"Enter a URL:\", \"https://\");\n          document.execCommand(\"createLink\", false, link);\n          break;\n        default:\n          break;\n      }\n    });\n  });\n};\n"],"names":["config","autsavedMsg","str","get_string","done","string","stringToHTML","support","window","DOMParser","parser","parseFromString","err","body","childNodes","dom","document","createElement","innerHTML","toggleAutotranslateButton","checkboxItems","checkboxes","forEach","e","push","checked","find","console","log","autotranslate","autotranslateButton","disabled","selectAll","querySelector","addEventListener","target","querySelectorAll","id","editor","sourceText","formData","FormData","append","lang","apikey","xhr","XMLHttpRequest","onreadystatechange","readyState","DONE","status","data","JSON","parse","responseText","translations","text","saveTranslation","open","send","getTranslation","getAttribute","translation","errorMessage","classList","add","call","methodname","args","course_id","length","indicator","after","setTimeout","indicatorNode","parentNode","removeChild","successMessage","fail","error","addClass","remove","controls","prepend","url","URL","location","href","searchParams","set","value","newUrl","toString","button","execCommand","link","prompt"],"mappings":"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"}